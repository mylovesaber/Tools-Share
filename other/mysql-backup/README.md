# MySQL 数据库简易备份工具
## 简介

> mariadb和mysql数据库备份工具，可联网的通用环境和涉密设备专用环境均可使用（涉密系统非root用户功能模块暂时没测）

测试软件及版本：
- mysql 5.7.x
- mariadb 10.5.17

核心调用程序：
- yq(第三方)
- mysqldump

必要名词（后文有介绍这是什么）：
- 基本单元
- 操作

设计思路(针对数据库备份计划):
1. 声明一个基本单元(一个数据库连接所需信息)，每个基本单元可以有一个或多个【任务名】，因为工具运行只以【任务名】进行操作管理
2. 通过 yaml 配置文件来配置任意数量基本单元各自的详细信息，这些基本单元各自信息通过解析 yaml 文件来实现获取，可通过 `检查(check)` 以获取详细解析结果
3. 本工具通过 `运行(check)` 以备份任意别名对应 MySQL 中的数据库，通过 `安装(install)/移除(remove)`以向系统中 `添加/取消/更新` 定时备份计划
4. 备份的颗粒度是一个库，其中包括了该库中所有的表，无法直接对具体某个库的表进行备份（暂时没做这功能）

### 基本单元

**注意：本工具同时支持 yml 和 yaml 后缀名的配置文件，即 `sqlbak.yml` 和 `sqlbak.yaml`，默认生成的是 `sqlbak.yml`**

本工具会根据实际用户在对应预设位置查找所需配置文件，如果没有则会自动生成一个模板(比如输入`sqlbak check`命令可以自动生成配置文件)，只需在对应模板中添加必要的信息即可。
以下是模板举例(总共有四种基本单元)：
```yaml
# 例1：一个基本单元中只有一个数据库需要备份
name1:
  ip: localhost
  port: 3306
  user: root
  password: root
  backup-path: /opt/backup/project
  expires-days: 10
  cron-format: "* * * * *"
  database: aaa

# 例2：一个基本单元中有多个数据库需要备份
name2:
  ip: 127.0.0.1
  port: 3307
  user: root
  password: 1234
  backup-path: /opt/backup/multiple-sql
  expires-days: 10
  cron-format: "0 1 * * *"
  database: 
    - aaa
    - bbb
    - ccc
# 例3：一个基本单元中只有一个数据库在所有库备份时被排除
name3:
  ip: 10.0.0.10
  port: 3306
  user: root
  password: root
  backup-path: /opt/backup/project
  expires-days: 10
  cron-format: "* * * * *"
  exclude-database: aaa

# 例4：一个基本单元中有多个数据库在所有库备份时被排除
name4:
  ip: 192.168.1.10
  port: 3307
  user: root
  password: 1234
  backup-path: /opt/backup/multiple-sql
  expires-days: 10
  cron-format: "0 1 * * *"
  exclude-database:
    - aaa
    - bbb
    - ccc
```
**解析(同时支持mysql和mariadb，后统称mysql)：**

| 键                | 值的介绍                                                                                                          |
|------------------|---------------------------------------------------------------------------------------------------------------|
| name             | 任务名，模板中 `name` 本身需要根据实际需要随意调整，禁止名称中包含 `@_` 的组合字样，程序中依靠这两个组合在一起的字符串来拆分名称的                                      |
| ip               | IP 地址，即此 ip 对应服务器上应该装有 mysql 或 mariadb，如果是本地则支持 localhost 和 127.0.0.1 这类写法                                    |
| port             | mysql 对外暴露的端口号                                                                                                |
| user             | 用于登录 mysql 的用户名                                                                                               |
| password         | 用户登录 mysql 的密码                                                                                                |
| backup-path      | 需要备份到哪个路径下，如果是非 root 用户则会启用内置的权限检测模块以确保备份的时候不会因为权限问题而无法写入                                                     |
| expires-days     | 过期天数，定时备份计划会产生很多备份文件，超过这个天数之前的文件均会被删除，设置 0 即该基本单元不删除任何备份                                                      |
| cron-format      | 需要填写 linux 版本的 cron 定时，没有检测流程，直接传递给系统，所以必须填写正确的定时写法并 ***用双引号扩起来***                                            |
| database         | 待备份的数据库名，如果是一个数据库则在 databbase 冒号空格后直接填写（上文例1），多个数据库则写成列表格式（上文例2）                                              |
| exclude-database | 整个mysql备份时需排除的数据库名，如果是一个数据库则在 databbase 冒号空格后直接填写（上文例3），多个数据库则写成列表格式（上文例4）<br/>注意，mysql5.7没有这功能，工具运行时会警告并主动阻断 |


### 操作

| 操作名称           | 用途                                 |
|----------------|------------------------------------|
| rebuild-cron   | 非root用户修改自定义定时任务后手动与已安装数据库备份计划组合重建 |
| update         | 自动更新本工具正常工作所需依赖                    |
| install        | 指定配置文件中存在的一/多个任务名，安装为系统定时备份计划      |
| remove         | 指定配置文件中存在的一/多个任务名，删除其已设置的定时备份计划    |
| run            | 指定配置文件中存在的一/多个任务名，运行其备份操作          |
| check          | 检查并打印配置文件中的指定一/多个任务的详细配置信息         |
| destroy        | 彻底卸载本工具并还原非root用户自定义的系统定时          |
| help或-h或--help | 打印此帮助菜单并退出                         |

## 操作与用法
操作步骤：
1. 直接命令行输入 `sqlbak` 查看完整帮助菜单，里面有各种 `操作` 的名称
2. 带上任意 `操作` 运行工具以自动生成配置文件(如果不存在配置文件)
3. 修改配置文件，将需要备份的数据库信息填写进去
4. 根据需要选择合适的 `操作` 并运行工具

注意:
1. 直接输入 `sqlbak` 即可运行本工具
2. 本工具生成配置文件所需 `操作` 不包括 `help/--help/-h` 选项
3. 对于非root用户使用本工具且系统中已有或未来需要新增其他定时任务的需求，必须执行此命令以完成当前用户系统定时重建: `sqlbak rebuild-cron`
4. `update` 和 `destroy` 功能只有在非限制性或非涉密系统上，且有公网连接的情况下才可以使用（暂未适配），否则一律用不了，会被屏蔽


### 用法
```bash
#单任务:
sqlbak [操作] [任务]

#多任务: 
sqlbak [操作] [任务1] [任务2] [任务3] ...

```

明确操作种类但不知道任务名(相同功能，二选一):
```bash
sqlbak [操作] help
sqlbak [操作]
```

## 实例

>Q: 安装时报错形如： rpmlib(PayloadIsZstd) <= 5.4.18-1 is needed by sqlbak-anshare-1.0.0-1.fc38.noarch 是什么意思？

目前此工具及其对应依赖已一起打包了，通过提供安装包的方式安装，此报错一般是打包时所用系统的依赖的版本高，但安装此安装包的系统版本即对应的依赖过老导致。
fedora31是个分水岭，在此发行版的版本及之后的系统制作的rpm安装包无法在老版本系统比如centos7上安装，本安装包尽量用centos7.9制作以确保兼容性。


---

>Q: 第一次用不知道怎么用？

在命令行中输入以下命令可以查看帮助菜单(所有行功能均相同，选一行执行即可)
```bash
sqlbak
sqlbak -h
sqlbak help
sqlbak --help
```

---

>Q: 已经知道基本操作流程了，但配置文件在哪？

【操作】只有这四个【install/remove/run/check】可以生成所需配置文件模板，之后输入 `sqlbak` 就可以看到帮助菜单最下面有当前用户对应的配置文件的绝对路径。以下命令随便一个就行。
```bash
sqlbak install
sqlbak install help
sqlbak remove
sqlbak remove help
sqlbak run
sqlbak run help
sqlbak check
sqlbak check help
```

---

>Q: 以 check 为例，`sqlbak check` 和 `sqlbak check help` 有什么区别？

后面 help 加不加都一样，只要没有加上具体的任务名，其功能就是单纯是显示帮助菜单。但有的人心理上过不去，不加help就不知道怎么用了，所以加上这功能安慰下这类用户（作者本人）。
```bash
sqlbak check
sqlbak check help
```

---

>Q: 未来此工具更新的时候怎么更新系统中已有的sqlbak？

因为此工具仅以安装包安装的形式进行安装，所以执行【update】后，当且仅当工具检测到有公网连接且没有运行再限制性或涉密系统上时才会从网上下载安装包并自动安装。此功能暂未适配。


---

>Q: 为何操作【update】输入后会有提示还剩多少次机会可以升级？

假设本地是很久以前安装的软件包，那么想用最新版本的话就需要输入命令：
```bash
sqlbak update 
```
本工具在检测有公网连接且没有运行再限制性或涉密系统上时将在线更新，否则退出。
至于剩余多少次机会是因为 github 有 API 访问频率限制，即每次下载时就已经消耗了一次机会，在调试时经常超标导致后续无法调试，所以才有这个提示。

如果超标的话不用急，github 的剩余次数每小时会重置一次。

---

>Q: 已经知道需要什么操作了，但不知道任务名有哪些？

以 check 为例，输入 `sqlbak check` 帮助菜单下面会看到已安装和未安装的任务名，一行一个。

需要注意的是，有且仅有【install/remove/run/check】这几个操作可以显示出有哪些任务名，以及他们各自是否已安装
```bash
sqlbak install
sqlbak remove
sqlbak run
sqlbak check
```

---

>Q: 这些任务名从哪冒出来的？

只要编辑了生成的配置文件模板就会出现，以本教程上方提供的有两个范例的配置文件模板来看，如果将系统中的配置文件改成上面的模板样子，那么任务名就会显示为：
```bash
已安装备份任务如下：

未安装备份任务如下：
name1
name2
```
因为都没安装，所以 `已安装备份任务如下：` 就会显示空行

---

>Q: 我已经安装上了一些任务，但后来有些任务名因各种原因导致任务名称必须要修改，怎么办？

比如已经安装了任务 `name1` ，想改名成 `name3`，则在配置文件里面把这名字改掉，然后执行命令 `sqlbak install` 即可看到 `name1` 消失而 `name3` 出现了，所以只需要再执行 `sqlbak install name3` 即可。
本工具中内置一个运行环境检测模块，以配置文件设置的内容为绝对正确，系统环境中如果有遵循本工具对系统定时任务命名规则且配置文件中不存在的任务名，则该任务将会被移除。
也就是安装 `name3` 的时候，`name1` 就会被删掉

---

>Q: 我已经安装上了某个任务，但后来任务中的一些信息需要修改，怎么办？

比如已经安装的改名后的任务 `name3` 的备份路径是 `/opt/backup/project`，想改成 `/opt/bak`，则在配置文件里面把这路径改掉，然后不用管了，原有的备份还在，只是已经安装的任务在下次执行的时候会自动备份到修改后的路径下。

因为本工具设计运行功能时只针对任务名，也就是具体某个任务名里面有哪些配置细节，本工具运行时会拿着指定的任务名自动从配置文件中解析它的所有细节配置，而不是预先存储到对应地方，然后对那地方的细节进行读取和调用。

不过如果什么都不做的话，虽然正常运行，但配置文件内容在安装的时候会安装到定时任务里面作为标记而存在，只改配置文件的话，这些标记不会更新。
虽然完全不会影响到运行结果，但不能接受有残留废弃信息存在的话，可以运行 `sqlbak install name3` 即可。对于同任务名的计划，重复安装等于更新安装进系统的信息，比如定时规则，如果修改了配置文件，则必须执行install来实现配置更新。

---

>Q: 我改好了配置文件，想一次性将全部任务安装上，怎么操作？

只有这四个操作名【install/remove/run/check】在其后面填写任务名的时候都可以使用特殊任务名：`all`，不过在其后面禁止添加其他任务名，非要加也没事，因为脚本会主动阻断，例：
```bash
sqlbak install all
```

---

>Q: 我已经安装了配置文件中定义的一部分任务了，现在想把剩下所有未安装的一次性安装上去，如何操作？

只有操作名为【install】才有一个独占的特殊任务名：`rest`，此任务名将会自动将所有未安装的任务全部安装上。不过在其后面禁止添加其他任务名，非要加也没事，因为脚本会主动阻断。
```bash
sqlbak rest
```

---

>Q: 我不知道配置文件我是否修改的正确，想看看sqlbak解析出来是什么结果，怎么查看某个任务？如果查看所有配置文件解析结果呢？

假设有四个任务名`name1/name2/name3/name4`
```bash
# 只查看name1解析结果
sqlbak check name1

# 只查看name2和name4解析结果
sqlbak check name2 name4

# 查询所有任务的解析结果
sqlbak check all
```

---

>Q: 我运行sqlbak报类似这种错是什么原因：Error: bad file 'xxx.yaml': yaml: line 8: did not find expected alphabetic or numeric character

配置文件有问题，检查对应行也就是配置文件里面的 `cron-format` 字段的值，**必须用英文双引号将其扩起来**，yq 无法识别特殊字符和空格

---

>Q: 我看sqlbak解析结果似乎没问题，但为何安装以后没有效果？

假设有问题的任务名是 `name1`，那么非保密电脑上运行的话就两个可能，一个是配置文件填写的确有问题，而且刁钻到本工具并没有考虑到这种情况，那么只需要执行以下命令后查看是否有对应备份压缩包在指定路径下生成即可。

```bash
sqlbak run name1
```
如果确认手动正常工作的话，那肯定是定时存在问题，需要自行检查。

---

>Q: 我用这个工具会不会把我以前设置的定时任务给破坏掉？

有可能的。这种情况发生在非root用户前提下，有两种操作会导致这种问题发生（限制性或涉密系统禁用了 destroy 功能所以不必担心）

第一种是此工具从未安装过，但用户上来就执行了卸载工具的功能，那么一定会将非root用户当前已有的定时任务全部清空。

```bash
sqlbak destroy
```
以上命令只有在本工具安装过的前提下才可以使用，因为其内置了一套备份恢复用户自定义的第三方定时任务的功能。

第二种是此命令安装后，传统的手动设置定时任务已经被占用了，未来如果非root用户通过命令 `crontab -e` 来手动添加其他定时任务的话，只要再运行过本工具，则之前设置的定时任务就全部被清空了。

为了避免该问题的出现，本工具专门设置了一个允许用户填写定时规则的文件，输入 `sqlbak` 所显示的最下面有一行名为：`非root用户增减其他定时任务文件:`，

此行显示的文件的绝对路径就是帮助记录用户自定义定时规则的文件，假设非root用户名为test，那么此定时文件路径默认是: `/home/test/.local/sqlbakcron/other-cron`。

只需要将需要添加的定时配置写在此文件中，一行一个，然后执行以下命令，本工具就会把用户自定义配置和数据库备份功能整合后安装进系统：
```bash
sqlbak rebuild-cron
```

注意，这种可能导致用户自定义定时任务丢失的问题仅出现在非root用户下，root用户是完全兼容的，根本不用担心，本工具大量检测判断均是为非root设置的，root很省事基本没有需要过多操作的地方。

---

>Q: 如果我想彻底卸载这个工具怎么办？

~~你是不是找事？？？重装系统吧~~

```bash
sqlbak destroy
```





