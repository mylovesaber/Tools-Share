# 介绍

此脚本用于定时执行多节点文件或文件夹的备份和同步。
功能相当灵活，有30个有参或无参选项任意次序组合（做了非常多限制所以做成了五大类6种功能，否则总组合数量超过三千种），
内部除了脚本文件名和清理过期日志的规定天数是魔法值外，包括调用这些魔法值的所有功能均为动态获取或外部传参实现
结构设计之初就是为了任何服务器集群均能使用的目的去做的，同步和备份功能均做成了基本单元，任何复杂备份或同步方案（单机多盘，多机多盘，跳板或堡垒机控制内网多机）均可以通过堆积木的方式实现。

# 工作流程

脚本启动全部功能的主流程：
- 脚本运行环境检测
- 免密环境完整性检测和自动修复
- 多种传参组合及每个选项合法性检测
- 免密节点组检测和指定错误后的可用列表提醒（防止用户部署错免密组）
- 同组节点检测和出错后的可用列表提醒（防止用户部署错免密组内的节点）
- 多节点连接性检测（节点硬件损毁）
- 用户传入的始末节点文件夹路径检测和自动修复
- 脚本基于时间进行需传输文件锁定，用户传入模糊时间格式，脚本自动解析并在后续锁定需传输文件时自动比对（时间基本单元）
- 考虑到不同平台不同项目的同步或备份需求既可能有文件夹也可能有文件，所以有选项要求用户每次可以指定传输文件夹还是文件（文件类型基本单元）
- 用户可以指定最长历史天数搜索并执行以下检索功能（怕节点损毁维护人员没即时发现导致损毁当日文件没来得及同步或备份，只查询距离当日指定最长天数内的最新日期，查不到会报错退出）
- 同步时始末节点文件夹和文件查缺补漏（前者是考虑到上一个功能的情况）
- 同步时始末节点任意层级文件夹内都存在的文件比对 sha256 值，存在冲突则不传输
- 始末节点文件冲突情况写入单独的报错警告日志方便开发查看
- 备份时是直接传输（scp对于重复传输的内容是直接覆盖）
- 当天的全部操作均会记录到以日期为名称的完整日志中，有出现传输检测故障或文件冲突等问题都将写入当日日志中（不同于完整操作记录日志，脚本工作正常当日就不会生成该文件）
- 脚本自带过期日志清理功能，默认指定的是10天为有效期（魔法值）
- 需要同步和备份的节点和节点组有自由部署和卸载功能
- 部署测试的清理功能（debug用）

# 特点

- 为防止部署时出现意外情况，检测和执行是完全分开的，不通过确认选项无法启动执行操作
- 堆积木举例：双机先同步再交叉备份：脚本执行三次一键部署，第一次同步部署，第二三次交叉备份部署
- 脚本一切传输基于scp（有一些不联网的设备没有rsync或syncthing甚至没有sftp，所以考虑通用性用的scp），一切检测查询使用ssh实现，基于定制免密环境
- 部署后的自动执行基于部署时指定的系统定时方案	
- 功能安装卸载时都会尽量照顾到机内各种已有功能和维护人员可能进行的各种骚操作，甚至考虑到维护人员可能存在的主动破坏脚本工作环境下的自修复情况，尽量不影响到已有功能的正常工作且不存在卸载后的任何残留
- 脚本部署时完全不需要指定具体节点的IP，此功能基于免密部署脚本（为防止和机内已有的通用免密冲突已有处理），
- 为了不影响和防止维护人员操作导致免密临时失效，免密方案均使用ssh的高级功能实现完全独立（限制ssh版本必须是2017年大版本更新之后的7.4版本），以避开和现有方案的冲突情况，实在有维护人员想秀操作也会尽量照顾到。
- 部署完成后屏蔽了连接用户名、公密钥信息、IP地址，转而使用节点别名的方式来控制，进行部署的时候只需要指定节点别名就可以实现连接
- 脚本设计是面向无限节点数和任意数量硬盘数以适应各种业务平台的备份同步需求，所以不限制脚本必须装在哪台设备上，甚至脚本部署到的节点本身是不存在任何需要备份同步的内容而是直接控制内网其他机器进行各种同步备份操作，这样可以部署在一台跳板机上，对内网各种机器进行统一指定传输方向和始末节点。

# 内置选项
## 全部选项

本脚本依赖SCP传输，所有内置选项及传参格式如下，有参选项必须加具体参数，否则脚本会自动检测并阻断运行。

如果不知道每个有参选项的参数怎么写，可以乱写，然后不使用 -y 选项以查看脚本检测结果会有什么报错情况出现，然后针对性调整输入参数即可。

```bash
# 以下为有参选项，必须带上相应参数
--sync_source_path     同步源路径
--sync_dest_path       同步目的路径
--backup_source_path   备份源路径
--backup_dest_path     备份目的路径
--sync_source_alias    同步源节点别名
--sync_dest_alias      同步目的节点别名
--backup_source_alias  备份源节点别名
--backup_dest_alias    备份目的节点别名
--days                 指定允许搜索的最长历史天数

-G  |  --sync_group             同步需指定的免密节点组名
-g  |  --backup_group           备份需指定的免密节点组名
-T  |  --sync_type              同步的内容类型(文件或文件夹:file或dir)
-t  |  --backup_type            备份的内容类型(文件或文件夹:file或dir)
-D  |  --sync_date_type         指定同步时包含的日期格式
-d  |  --backup_date_type       指定备份时包含的日期格式
-N  |  --sync_operation_name    指定部署的同步操作名称(仅部署时用于识别，执行时可不写)
-n  |  --backup_operation_name  指定部署的备份操作名称(仅部署时用于识别，执行时可不写)
-O  |  --operation_cron         指定方案组工作的定时规则
-o  |  --operation_cron_name    指定方案组名称
-E  |  --log_cron               指定删除过期日志的定时规则
-R  |  --remove                 指定卸载脚本的节点别名
-r  |  --remove_group_info      指定卸载脚本的节点所属免密节点组名
-F  |  --remove_operation_file  指定卸载脚本的节点中的方案组名(all代表全部卸载)
-L  |  --deploy                 指定部署脚本的节点别名
-l  |  --deploy_group_info      指定部署脚本的节点所属免密节点组名

# 以下为无参选项:
-s  |  --check_dep_sep       只检测并打印脚本运行必备依赖情况的详细信息并退出
-e  |  --delete_expired_log  即时删除超期历史日志文件并退出
-c  |  --clean               清理脚本在本地测试运行或部署功能时的残留(不含指定错误路径导致的文件夹被新建情况)
-y  |  --yes                 确认执行所有检测结果后的实际操作
-h  |  --help                打印此帮助信息并退出
```

## 功能选项组合
以下每个分类需要执行什么功能就把里面那些选项全部使用上，如果只是检查就别加 -y 选项即可。
### 部署同步功能

```bash
# 以下为有参选项，必须带上相应参数
--sync_source_path   同步源路径
--sync_dest_path     同步目的路径
--sync_source_alias  同步源节点别名
--sync_dest_alias    同步目的节点别名
--days               指定允许搜索的最长历史天数

-G  |  --sync_group           同步需指定的免密节点组名
-T  |  --sync_type            同步的内容类型(文件或文件夹:file或dir)
-D  |  --sync_date_type       指定同步时包含的日期格式
-N  |  --sync_operation_name  指定部署的同步操作名称(仅部署时用于识别)

-O  |  --operation_cron       指定方案组工作的定时规则
-o  |  --operation_cron_name  指定方案组名称
-E  |  --log_cron             指定删除过期日志的定时规则
-L  |  --deploy               指定部署脚本的节点别名
-l  |  --deploy_group_info    指定部署脚本的节点所属免密节点组名

# 以下为无参选项:
-y  |  --yes  确认执行所有检测结果后的实际操作
```

### 部署备份功能

```bash
# 以下为有参选项，必须带上相应参数
--backup_source_path   备份源路径
--backup_dest_path     备份目的路径
--backup_source_alias  备份源节点别名
--backup_dest_alias    备份目的节点别名
--days                 指定允许搜索的最长历史天数

-g  |  --backup_group           备份需指定的免密节点组名
-t  |  --backup_type            备份的内容类型(文件或文件夹:file或dir)
-d  |  --backup_date_type       指定备份时包含的日期格式
-n  |  --backup_operation_name  指定部署的备份操作名称(仅部署时用于识别)

-O  |  --operation_cron       指定方案组工作的定时规则
-o  |  --operation_cron_name  指定方案组名称
-E  |  --log_cron             指定删除过期日志的定时规则
-L  |  --deploy               指定部署脚本的节点别名
-l  |  --deploy_group_info    指定部署脚本的节点所属免密节点组名

# 以下为无参选项:
-y  |  --yes  确认执行所有检测结果后的实际操作
```

### 执行同步功能

```bash
# 以下为有参选项，必须带上相应参数
--sync_source_path   同步源路径
--sync_dest_path     同步目的路径
--sync_source_alias  同步源节点别名
--sync_dest_alias    同步目的节点别名
--days               指定允许搜索的最长历史天数

-G  |  --sync_group           同步需指定的免密节点组名
-T  |  --sync_type            同步的内容类型(文件或文件夹:file或dir)
-D  |  --sync_date_type       指定同步时包含的日期格式
-N  |  --sync_operation_name  指定部署的同步操作名称(仅部署时用于识别，执行时可不写)

# 以下为无参选项:
-y  |  --yes  确认执行所有检测结果后的实际操作
```

### 执行备份功能

```bash
# 以下为有参选项，必须带上相应参数
--backup_source_path   备份源路径
--backup_dest_path     备份目的路径
--backup_source_alias  备份源节点别名
--backup_dest_alias    备份目的节点别名
--days                 指定允许搜索的最长历史天数

-g  |  --backup_group           备份需指定的免密节点组名
-t  |  --backup_type            备份的内容类型(文件或文件夹:file或dir)
-d  |  --backup_date_type       指定备份时包含的日期格式
-n  |  --backup_operation_name  指定部署的备份操作名称(仅部署时用于识别，执行时可不写)

# 以下为无参选项:
-y  |  --yes  确认执行所有检测结果后的实际操作
```

### 卸载方案组或全部功能

```bash
# 以下为有参选项，必须带上相应参数
-R  |  --remove                 指定卸载脚本的节点别名
-r  |  --remove_group_info      指定卸载脚本的节点所属免密节点组名
-F  |  --remove_operation_file  指定卸载脚本的节点中的方案组名(all代表全部卸载)

# 以下为无参选项:
-y  |  --yes  确认执行所有检测结果后的实际操作
```

# 选项组合举例

请仿照 [测试记录](../multi-sync-backup/%E6%B5%8B%E8%AF%95%E8%AE%B0%E5%BD%95.md) 文档中的配置内容进行部署和执行。

定时功能请看: [定时教程](cron.md)

# ChangeLog
### 2022-11-29  v1.0.2

scp 传输时增加保留原始的时间戳等原有信息的功能

### 2022-11-26  v1.0.1

改动如下:
1. 重构核心功能逻辑
2. 大幅减少 ssh 和 scp 会话开关次数，所有备份功能和文件同步功能的各步骤中所需开关次数均已降低到一次
3. 文件夹同步的传输功能已降低会话开关次数到等于同步目录内所有子文件夹数量

以上处理使得创建文件索引、文件完整性对比校验、传输工作等功能的性能大幅提升。
在测试中，部分情况下(最新日期距离运行时的日期久远、大量文件传输等等)工作效率是首版的几倍至几十倍不等。
此版未对性能做极限优化，在保证兼容性的前提下，保留了部分方便调试但会对性能产生微小影响的逻辑结构(工作用时会延长几秒钟，但远没到首版的几分钟的情况)。

### 2022-07-22  v1.0.0

因为全部检测和传输均使用节点传输方式，所以在每日存在较大文件量的时候运行效率低下（每日一万以上文件数应该会比较明显，现测试文件总数只有500出点头已经有征兆了）：
1. 为了极致灵活性降低了效率，连脚本所在本机都是以节点的方式进行scp和ssh连接，所以开启会话延时会比较明显
2. 初版只是实现功能，结构后续还需优化（~~双机部署考虑使用生成子脚本以固定本机情况(感知不强，已放弃)~~、检测和传输逻辑调整等，后者会增加节点损毁时传输失败的文件数量，但节点正常时会缩短多文件的传输时长）