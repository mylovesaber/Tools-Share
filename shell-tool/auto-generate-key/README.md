# 工具介绍
## 简介

此工具用于在多节点中搭建相互免密的环境以便后续各种自动化部署工具可以稳定运行提供先决条件，且因其内置的功能实现（类比 JAVA Bean），
使得此仓库内基于此工具实现各种自动化功能的工具都可以做到功能性和用户操作复杂度的相对平衡。
此工具目前没有开发完，暂时仅完成了安装功能的主体部分，但足够一键部署和后期维护使用了。

## 工作流程

以下为此工具的工作流程：
- 环境和工具必备依赖检测
- 用户输入选项组合检测
- 用户输入参数检测
- 节点状态检测
- 预期结果显示
- 执行本机部署
- 增加正常免密节点的自动推送更新
- 生成新节点的自动部署和免密故障节点的自动修复子脚本

此工具工作流程默认分离检测和执行以防用户操作失误，在输入特定选项（-y 或 --yes）确认操作之前，执行功能及以下功能将直接跳过。
执行功能之前的所有流程一旦发现问题将报错和提示错误原因并立即终止运行，所以指定选项和参数的时候不用担心会出现意想不到的故障情况以及对系统进行破坏性写入。

## 设计思路

此工具设计思路如下（包含暂未实现功能，已实现功能请看实装选项）：
假设有n个服务器（内网节点），其中有一台堡垒机或跳板机。
除跳板机外其他所有内网节点按照业务（task-A/task-B/task-C ...）进行分组，称作：业务免密节点组。
每个业务免密节点组内包含了特定节点的信息和对应公密钥文件。
- 不同业务组内的节点无论是否处于同一个网段，皆因公密钥不同而不能相互自由访问
- 相同业务组内的所有节点之间无论是否在同一网段，只要可被ping通，就可以随意无密码访问（能 ping 通除了系统内没有禁用 ping 以外，还需要网关做好设置，这不是该工具职能所属）
- 堡垒机或跳板机内可以存储所有业务免密节点组和对应组内节点信息及各自公密钥文件以便实现对内网任意业务组中的任意节点实现无密码访问

# 实装选项

选项分为长选项和短选项，帮助菜单中同一行的长短选项效果相同二选一
例: `-h  |  --help           打印此帮助信息并退出`

则 `bash xxx.sh -h` 和 `bash xxx.sh --help` 功能相同。

```bash
以下为有参选项，必须带上相应参数
-G  |  --deploy_group_name  设置免密节点组名称
-N  |  --deploy_node_info   设置组内每个节点的信息(每个节点信息填写顺序为：节点别名,登录名,IP,端口号，不同节点信息用空格隔开)
-t  |  --type               设置生成密钥的类型(可选类型:dsa/ecdsa/ed25519/rsa/rsa1)

以下为无参选项:
-s  |  --check_dep_sep  只检测并打印脚本运行必备依赖情况的详细信息并退出
-y  |  --yes            确认执行所有检测结果后的实际操作
-h  |  --help           打印此帮助信息并退出
```

|密钥类型|介绍|
|---|---|
|rsa/rsa1|诞生最早，应用最广泛，兼容性最强，性能一般|
|dsa|安全性存在问题，几乎没人用|
|ecdsa|dsa改良版，安全性和rsa同级别但密钥更短|
|ed25519|性能最强，安全性最强，只兼容 2014 年以后的 ssh6.5 以上版本|

# 教程
## 查看工具帮助菜单

```bash
bash <(cat auto-generate-key.sh) -h
```

## 检查工具运行必备依赖情况的信息信息

```bash
bash <(cat auto-generate-key.sh) -s
```

## 安装教程

**全新安装** 和 **追加新节点** 功能所需选项区别仅为是否指定密钥类型。
工具具体功能实现写法所基于的例子：
有 6 台服务器，其中一台服务器为跳板机，登录信息为：
- 别名：jump
- IP：1.1.1.1
- 登录名：root
- SSH 端口号：22


有两个业务名为：task-A 和 task-B

业务 A 需要两台服务器，各自登录信息为：
节点2：
- 别名：ta002
- IP：10.0.0.2
- 登录名：root
- SSH 端口号：22

节点3：
- 别名：ta003
- IP：10.0.0.3
- 登录名：root
- SSH 端口号：33

有两个业务名为：task-A 和 task-B
业务 B 需要三台服务器，各自登录信息为：
节点4：
- 别名：tb004
- IP：10.0.0.4
- 登录名：root
- SSH 端口号：44

节点5：
- 别名：tb005
- IP：10.0.0.5
- 登录名：root
- SSH 端口号：55

节点6：
- 别名：tb006
- IP：10.0.0.6
- 登录名：root
- SSH 端口号：66




### 全新安装(至少两个节点)

全新安装意思是创建一个新的业务组，并向其中增加至少两个免密节点信息。如果指定组名已存在且结构检测为本工具生成的结构，则表示为追加，且密钥类型指定失效。

可用选项：
```bash
以下为有参选项，必须带上相应参数

-G  |  --deploy_group_name  设置免密节点组名称
-N  |  --deploy_node_info   设置组内每个节点的信息(每个节点信息填写顺序为：节点别名,登录名,IP,端口号，不同节点信息用空格隔开)
-t  |  --type               设置生成密钥的类型(可选类型:dsa/ecdsa/ed25519/rsa/rsa1)

以下为无参选项:
-y  |  --yes  确认执行所有检测结果后的实际操作
```

例：
为业务组 A 所有节点创建免密环境：
```bash
# 检查和模拟部署后会看到什么信息
bash <(cat auto-generate-key.sh) -G "task-A" -N "ta002,root,10.0.0.2,22 ta003,root,10.0.0.3,33" -t "ed25519"

# 开始执行
bash <(cat auto-generate-key.sh) -G "task-A" -N "ta002,root,10.0.0.2,22 ta003,root,10.0.0.3,33" -t "ed25519" -y

```

为业务组 B 中的节点 4 和节点 6 创建免密环境：
```bash
# 检查和模拟部署后会看到什么信息
bash <(cat auto-generate-key.sh) -G "task-B" -N "tb004,root,10.0.0.4,44 tb006,root,10.0.0.6,66" -t "ed25519"

# 开始执行
bash <(cat auto-generate-key.sh) -G "task-B" -N "tb004,root,10.0.0.4,44 tb006,root,10.0.0.6,66" -t "ed25519" -y

```

### 追加新节点(一个或多个)

追加意思是指定的节点组名已存在且结构检测为本工具生成的结构，本工具在本机增加新的节点信息后做两件事：
1. 生成基于本机指定节点组名内新增后包含全部免密节点信息的新节点自动部署和故障节点自动修复的子脚本
2. 向免密环境正常的其他所有节点发送新增后的所有免密节点信息

可用选项：
```bash
以下为有参选项，必须带上相应参数

-G  |  --deploy_group_name  设置免密节点组名称
-N  |  --deploy_node_info   设置组内每个节点的信息(每个节点信息填写顺序为：节点别名,登录名,IP,端口号，不同节点信息用空格隔开)

以下为无参选项:
-y  |  --yes  确认执行所有检测结果后的实际操作
```

例：
假设业务组 B 已为节点 4 和节点 6 创建了免密环境。
为业务组 B 新增节点 5：
```bash
# 检查和模拟部署后会看到什么信息
bash <(cat auto-generate-key.sh) -G "task-B" -N "tb005,root,10.0.0.5,55"

# 开始执行
bash <(cat auto-generate-key.sh) -G "task-B" -N "tb005,root,10.0.0.5,55" -y

```

如果节点 4 和 6 免密没有任何问题的话，在 4 或 6 上任意一个节点新增节点 5，都将自动把节点 5 的信息发送到对应组内所有正常免密的节点中，如果 4 和 6 免密出现问题的话，则新生成的子脚本在 4 或 6 上运行将修复免密故障。