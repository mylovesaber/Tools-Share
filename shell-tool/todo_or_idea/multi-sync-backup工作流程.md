# 脚本工作条件

- 免密环境必须由 auto-generate-key.sh 脚本完成免密部署或人为按照脚本的工作流程完成新增节点的免密配置。
- 脚本运行时会立即检测是否以 root 用户执行，如果不是的话会报错退出

# 脚本可用参数介绍


# 用户传参检测流程

以下列表从上到下按顺序执行（中间有中断的话是一行写不完，需要单独解释，但整体顺序不会变）：
- 检测 /root/.ssh/config 文件是否存在，如果存在，从中获取后续检测流程需要的必要信息，该文件由上面脚本工作条件类目中的预部署脚本生成，如果不存在则报错退出。
- 检测是否需要立即显示帮助信息，检测到选项后排除其他所有选项并打印帮助信息后退出，此选项拥有最高优先级
- 检测是否需要立即卸载该脚本的全部部署流程，检测到选项后排除其他所有选项并卸载整个部署内容并退出进程，不会影响其他任何系统内容
- 检测是否需要立即移除超过此脚本规定保留时间的所有工作日志，检测到选项后删除所有超时日志并退出
- 检查脚本使用的有关软件安装情况，如果存在脚本依赖但系统未安装的软件包或功能，则提示缺少的具体依赖信息并退出，否则只提示依赖满足并进行之后的检测流程，此处有选项可以只运行依赖检测并退出，启用此功能的话将比默认检测多打印每一个依赖情况
- 检查用户是否设置超时时间，此选项用于传输过程中可能出现的网络波动或节点损坏之类的各种意外情况导致传输阻塞而未察觉的情况
- 检查用户是否指定了部署选项，如果不设置部署选项，所有传的参数对应的各种功能都是立即运行且只运行一次，而部署功能本身不会运行脚本，只是增加定时运行脚本功能和定时删除过期日志的本地环境设置。
- 如果指定了部署选项，则有三个选项必须指定，否则脚本会自动终止后续操作并退出，三个选项：标记、操作定时、删除过期日志定时
- 【标记】此功能目的是区分不同定时任务以及在卸载各自功能的时候不会错删其他正常功能，应用场景：三机或更多节点的交叉备份或同步，部署完成后更换过 IP 地址或节点名之类，需要单独指定功能重新部署，就靠写在【操作定时】中的标记信息来锁定
- 【操作定时】此功能用于设置定时运行脚本中的对应始终节点的同步、备份功能，传入参数的格式严格遵循 Linux 系统定时功能的写法，因为此选项直接传送到对应的定时位置，写错就没法用了，其他定时功能一样的要求。
- 【删除过期日志定时】本脚本工作时会实时生成日志方便后续调试和记录任何错误情况，此功能用于删除过期的日志内容，脚本内默认此功能运行时，立即删除 10 天后的日志。
- 创造多种多重备份所需的自由度但不会给用户造成过于麻烦的操作方式的限制结构，它是一个服务器节点信息把关的核心检测功能，但凡通过此结构筛选的所有服务器节点有关的选项参数，后文均不会对其所需要搭配的选项被用户漏输的单独判断而是直接进行参数处理。

此结构限制成了三种操作组合，输入其他选项组合将直接报错退出并提示用户以下三种操作组合各自有什么选项，分别是：
1. **【单备份功能】** 四个选项 **源备份节点路径+源备份节点别名+目标备份节点路径+目标备份节点别名** 同时有参数 **且** 四个选项 **源同步节点路径+源同步节点别名+目标同步节点路径+目标同步节点别名** 同时没有添加到传参列表中

2. **【单同步功能】** 四个选项 **源备份节点路径+源备份节点别名+目标备份节点路径+目标备份节点别名** 同时没有添加到传参列表中 **且** 四个选项 **源同步节点路径+源同步节点别名+目标同步节点路径+目标同步节点别名** 同时有参数

3. **【先同步再备份功能】** 八个选项 **源备份节点路径+源备份节点别名+目标备份节点路径+目标备份节点别名** 和 **源同步节点路径+源同步节点别名+目标同步节点路径+目标同步节点别名** 同时有参数

【单备份功能】和【单同步功能】各自都是只执行一轮操作，八个选项不同时指定的话，同步功能不会强制在备份功能之前运行。
【同步后备份】的组合功能已实现解耦，通过用户指定的参数决定，所以不同功能对应的节点路径和节点别名可以不同，比如 A、B 节点进行同步，同步完成后 A 向 C 节点传输备份，B 向 D 节点传输备份，B 也可以向 A 节点传输备份，但因为始终节点只有一对，所以暂不支持一个节点同时向多个节点传输，只能一个节点通过多组传输来向多个节点传输。

三种操作情况内均有各自的参数，但整体遵循以下检测方式：
- 为了让用户不用纠结用绝对路径还是相对路径以及不同系统会如何对待这些路径，脚本内已取消自动将相对路径修复成绝对路径的功能，改为强制用户输入的必须是绝对路径，脚本会检查各种路径是否为绝对路径，如果不是就报错退出让用户检查.
- 脚本接收节点别名并去 config 文件中进行查找，如果没有找到则表示此节点别名对应的节点不在免密节点组中或用户输错免密节点别名，本脚本将直接报错退出而不进行任何后续操作。


# 节点网络检测和路径修正

- 此脚本基于节点之间已实现免密的前提，所以为了防止因为用户输错节点 IP 导致脚本被输入密码的提醒设置阻塞，脚本只接收需要传输内容的节点的别名，这个别名在免密脚本进行预部署时也可以指定成对应的IP地址，详情请看免密脚本操作教程，脚本会去【用户传参检测流程】第一条的 config 文件中查找并将免密节点组信息改写成 `别名:IP地址` 的键值对并存在伪数组中（Shell 中字符串和数组转换时有时候会出现问题，为防出意外情况，实际是多行字符串，但长得像数组），在获取节点别名后，通过按别名搜索定位到对应的 IP 地址，之后对每一个 IP 地址进行 PING 操作以确认节点存活，所以对应的节点不能关闭禁止 PING 的功能，但凡一个节点损坏后，本脚本将直接报错退出而不进行任何操作。
- 脚本对绝对路径进行自动修正：
  1. 找到并删除路径末尾的斜线（/）（用户通过 Tab 键补全路径的话会导致输入的绝对路径末尾有斜线）。
  2. 找到路径中存在的所有单引号（'）并自动进行转义处理。
  3. 将剩余非单引号字符（符号+大小写字母+数字）全部用单引号括起来防止将未处理完全的路径作为变量提供给后续各种参数调用时出错。

# 正常同步策略



# 正常备份策略



# 用户操作和部署教程



---

# 对于用户传参的思考

因为有免密脚本的处理，所以 scp 或 ssh 连接节点的时候就不需要以 `用户名@IP地址` 的格式进行连接，而是直接跟节点别名即可，所以原始的完整写法:
`scp 源用户名@源IP:源路径 终用户名@终IP:终路径`
就可以缩写成:
`scp 源别名:源路径 终别名:终路径`
这样从 1296 种组合方式就缩减成了 288 种组合方式。
最终效果举个例子：

```
单同步：
            传参组合            是否可行
源路径+源别名 - 终路径+终别名      ✓
源路径+源别名 - 终路径            ✓
源路径+源别名 -      +终别名
源路径+源别名 - 
        源别名 - 终路径+终别名
        源别名 - 终路径
        源别名 -      +终别名
        源别名 - 
源路径       - 终路径+终别名      ✓
源路径       - 终路径
源路径       -      +终别名
源路径       - 
            - 终路径+终别名
            - 终路径
            -       终别名
            - 
```

1. 一个基本组合有两个元素等待用户指定: 路径、别名
2. 根据用户手滑程度，每个元素都有输入和未指定两种可能，两个元素有 2x2=4 种组合/单体/不存在的情况
3. 有始末两种途径，所以有 4x4=16 种组合
4. 有备份和同步两种方案，所以有 2+1=3 种组合或单体方案
5. 每种方案都有 16 种组合，所以共 16x16+16+16=288 种组合

即用户在运行脚本时传入的参数组合有 288 种写法，其中绝大部分写法都是错的,因此给出哪个参数错误不现实，于是只保留正确写法，其他一律算错误写法。
正确写法：

```
单同步：
源路径+源别名 - 终路径+终别名（不限制始末节点）
源路径+源别名 - 终路径（远程到本地）
源路径       - 终路径+终别名（本地到远程）

单备份：
源路径+源别名 - 终路径+终别名（不限制始末节点）
源路径+源别名 - 终路径（远程到本地）
源路径       - 终路径+终别名（本地到远程）

同步+备份：
同步源路径+同步源别名 - 同步终路径+同步终别名          备份源路径+备份源别名 - 备份终路径+备份终别名（不限制始末节点）
同步源路径          - 同步终路径+同步终别名           备份源路径          - 备份终路径+备份终别名（本地到远程）
同步源路径+同步源别名 - 同步终路径                    备份源路径+备份源别名 - 备份终路径（远程到本地）
```

路径一定得存在，别名不存在的话就是本机路径，但不能始末端都是本地路径。为了在用户操作的复杂度和自由度之间做个平衡（要自由但不能太复杂），如果强制用户指定所有的始末节点的别名和各自路径（脚本可能用得上的参数一律提供，不管脚本是不是真能用上），由脚本本身进行检测修复和判断，以上9种正确写法就可以缩略成以下三种情况：

```
单同步：
源路径+源别名 - 终路径+终别名（不限制始末节点）

单备份：
源路径+源别名 - 终路径+终别名（不限制始末节点）

同步+备份：
同步源路径+同步源别名 - 同步终路径+同步终别名     备份源路径+备份源别名 - 备份终路径+备份终别名（不限制始末节点）
```

如果任何一种节点是脚本运行时的本地节点也无所谓，因为 ssh、scp 运行的时候，可以直接 IP 或 别名 的方式连本地的，所以通过检测本地 IP 和节点 IP 是否是相同以便切换成本地路径读写就显得很累赘。